function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}!function(){var t,e,n;t={events:{mousedown:function(t){var e;if(this.mod.dragger.contains(t.target)){for(e=t.target;e&&(!e.hasAttribute||!e.hasAttribute("draggable"));)e=e.parentNode;return e?e.setAttribute("draggable",!0):void 0}},dragstart:function(e){var n,r,i,o;if(this.mod.dragger.contains(e.target))return n=this.mod.dragger,n.src=e.target,r=/inline/.exec(getComputedStyle(n.src).display)?"inline":"block",i={mode:r},(o=e.dataTransfer).setData("application/json",JSON.stringify(i)),o.setData("mode/"+r,""),o.setDragImage(t.ghost[r],10,10),n.setDrag(!0),e.stopPropagation()},dragover:function(t){var e,n,r,i,o;if(t.preventDefault(),e=this.mod.dragger,n=ldCaret.byPtr({node:this.root,x:t.clientX,y:t.clientY,method:"euclidean"}),e.contains(n.range.startContainer))return r=t.dataTransfer.types.map(function(t){return/mode\/(.+)/.exec(t)}).filter(function(t){return t}).map(function(t){return t[1]})[0]||"inline",e.render((o={},o.range=n.range,i=o,i.mode=r,i))},drop:function(t){var e,n;return e=[t.target,this.mod.dragger],n=e[1],t.preventDefault(),n.drop({evt:t})}},ghost:{block:(e=new Image,e.src="data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="15" viewBox="0 0 20 15">\n<rect x="0" y="0" width="9" height="15" fill="rgba(0,0,0,.5)"/>\n<rect x="11" y="0" width="9" height="15" fill="rgba(0,0,0,.5)"/>\n</svg>'),e),inline:(e=new Image,e.src="data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="15" viewBox="0 0 20 15">\n<rect x="0" y="0" width="20" height="3" fill="rgba(0,0,0,.5)"/>\n<rect x="0" y="4" width="20" height="3" fill="rgba(0,0,0,.5)"/>\n<rect x="0" y="8" width="20" height="3" fill="rgba(0,0,0,.5)"/>\n<rect x="0" y="12" width="20" height="3" fill="rgba(0,0,0,.5)"/>\n</svg>'),e)},init:function(){return this.mod.dragger=new n({root:this.root,editable:this})}},n=function(t){var e;return null==t&&(t={}),this.editable=t.editable,this.opt=t,e=t.root,this.root=e="string"==typeof e?document.querySelector(e):e||null,import$(this,{dragging:!1,caret:null,src:null}),this.caret={box:null,range:null},this.evtHandler={},this.init(),this},n.prototype=import$(Object.create(Object.prototype),{init:function(){return this.caret.box=document.createElement("div"),this.caret.box.classList.add("mod-dragger-caret"),document.body.appendChild(this.caret.box)},contains:function(t){return this.root.contains(t)},setDrag:function(t){return this.dragging=t},hostmatch:function(t){var e,n,r;for(e=t.parent,n=t.mode;e;){if(e.hasAttribute&&(r=0,"block"===n&&e.hasAttribute("hostable")&&(r+=1),"inline"===n&&e.hasAttribute("editable")&&"false"!==e.getAttribute("editable")&&(r+=2),r))return{parent:e,type:r};(e=e.parentNode)===this.root&&(e=null)}return{parent:e,type:r}},render:function(t){var e,n,r,i,o;return null==t&&(t={}),(e=t.range)?((n=this.hostmatch({parent:e.startContainer,mode:t.mode})).parent,r=n.type,i=r,o=e.getBoundingClientRect(),this.caret.range=e,import$(this.caret.box.style,{left:o.x+window.pageXOffset+"px",top:o.y+window.pageYOffset+"px",height:o.height+"px",display:"block",opacity:i?1:.4,filter:i?"":"saturate(0)"})):(n=this.caret.box.style,n.display="none",n)},drop:function(t){var e,n,r,i,o,a,d,s,l,g=this;if(e=t.evt,n=[this.caret.range,this.src],r=n[0],i=n[1],this.src=null,this.render(),r&&this.root.contains(e.target))return o=r.startContainer,a=e.dataTransfer.types.map(function(t){return/mode\/(.+)/.exec(t)}).filter(function(t){return t}).map(function(t){return t[1]})[0]||"inline",i?this.insert({range:r,parent:o,mode:a,node:i}):(d=(s=e.dataTransfer.getData("application/json"))?JSON.parse(s):{},console.log(">",d),"block"===d.type?d.dom?(l=function(){var t;return t=document.createElement("div"),t.innerText="Hello World!",{node:t}},datadom.deserialize(d.dom,l).then(function(t){var e;return(e=t.node).setAttribute("editable",!0),e.setAttribute("draggable",!0),g.insert({range:r,parent:o,node:t.node,mode:d.mode||"block"})})):window.bmgr.get(d.name).then(function(t){return t.create()}).then(function(t){var e;return e=document.createElement("div"),t.attach({root:e}),(e=e.childNodes[0]).parentNode.removeChild(e),e.setAttribute("block",""),e.setAttribute("draggable",!0),g.insert({range:r,parent:o,node:e,mode:d.mode||"block"})}):((i=document.createElement("block"===d.mode?"div":"span")).setAttribute("editable",!0),i.setAttribute("draggable",!0),datadom.deserialize(d.dom||{}).then(function(t){return i.innerHTML="",i.appendChild(t.node)}),this.insert({range:r,parent:o,node:i,mode:d.mode||"block"})))},insert:function(t){var e,n,r,i,o,a,d,s,l,g,c,h,u,p,m;if(e=t.parent,n=t.range,r=t.node,i=t.mode,o=[e,n,r,i],a=o[0],o[1],d=o[2],s=o[3],l=n.startContainer,g=n.startOffset,c=l.nodeType===Element.TEXT_NODE?l:l.childNodes[g],!ld$.parent(c,null,d)&&(o=this.hostmatch({parent:a,mode:s}),e=o.parent,h=o.type,a=e)){if(1&h)for(;c&&c.parentNode!==a;)c=c.parentNode;return c.nodeType===Element.TEXT_NODE?(d.parentNode&&d.parentNode.removeChild(d),u=c.textContent,[document.createTextNode(u.substring(0,g)),d,document.createTextNode(u.substring(g))].map(function(t){return c.parentNode.insertBefore(t,c)}),c.parentNode.removeChild(c)):(d.parentNode&&d.parentNode.removeChild(d),"block"===i?(p=document.createRange(),m=document.createRange(),p.setStart(a,0),p.setEnd(l,g),m.setStart(l,g),m.setEnd(a.nextSibling||a,a.nextSibling?0:a.childNodes?a.childNodes.length:a.textContent.length),p.toString().length>m.toString().length?c.parentNode.insertBefore(d,c.nextSibling):c.parentNode.insertBefore(d,c)):c.parentNode.insertBefore(d,c)),this.editable.fire("change")}}}),((e=window.editable).mod||(e.mod={})).register("dragger",t)}();