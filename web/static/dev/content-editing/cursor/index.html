<!DOCTYPE html><html><head><base href="/"><link rel="stylesheet" type="text/css" href="assets/lib/bootstrap/main/css/bootstrap.min.css"><link rel="stylesheet" type="text/css" href="assets/lib/bootstrap.ldui/main/bootstrap.ldui.min.css"><link rel="stylesheet" type="text/css" href="assets/lib/ldiconfont/main/ldif.min.css"><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,700|Roboto+Mono"><link rel="stylesheet" type="text/css" href="assets/lib/ldcover/main/ldcv.min.css"><link rel="stylesheet" type="text/css" href="assets/lib/focalbox/main/focalbox.min.css"><link rel="stylesheet" type="text/css" href="css/index.css"><link rel="stylesheet" type="text/css" href="/css/editable/index.css"><style type="text/css">/*
body {
  caret-color: transparent
}
*/
#ph {
  width: 3px;
  height: 1em;
  background: #f00;
  display: inline-block;
  pointer-events: none;
}
#ph-abs {
  width: 3px;
  height: 1em;
  background: #f00;
  display: inline-block;
  position: absolute;
  pointer-events: none;
}
</style></head><body><div><div id="ph-abs"></div><div id="ph"></div><div class="w-1024 rwd mx-auto my-4" id="root"><div class="m-4" id="simple" contenteditable="true"><div class="border border-danger p-2 m-2 d-inline-block">EF</div>AB<div class="border border-danger p-2 m-2 d-inline-block">CD<div class="border border-danger p-2 m-2 d-inline-block">GH<div class="border border-danger p-2 m-2 d-inline-block">IJ<div class="border border-danger p-2 m-2 d-inline-block"><div class="border border-danger p-2 m-2 d-inline-block"><div class="border border-danger p-2 m-2 d-inline-block">KL</div></div></div></div></div></div></div><br><div class="border p-2 m-2"><div class="border border-warning p-2 m-2" id="inner"><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="true">111</div>123<div class="border border-danger p-2 m-2 d-inline-block" id="tgt" draggable="true" contenteditable="false">222</div>456<div class="border border-danger p-2 m-2 d-inline-block" contenteditable="true">333</div><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="true">333</div><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="false">ccc<div class="border border-info d-inline-block">bbb<div class="border border-primary d-inline-block">aaa</div></div></div><br><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="false">111</div><div class="border border-danger p-2 m-2 d-inline-block" id="tgt" draggable="true" contenteditable="true">222</div><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="true">333</div><div class="border border-danger p-2 m-2 d-inline-block" contenteditable="false">ccc<div class="border border-info d-inline-block">bbb<div class="border border-primary d-inline-block">aaa</div></div></div></div><div class="border border-warning p-2 m-2">444</div></div><div class="border p-2 m-2">555</div></div></div><script type="text/javascript" src="assets/lib/bootstrap.native/main/bootstrap-native.min.js"></script><script type="text/javascript" src="assets/lib/bootstrap.ldui/main/bootstrap.ldui.min.js"></script><script type="text/javascript" src="assets/lib/@loadingio/ldquery/main/ldq.min.js"></script><script type="text/javascript" src="assets/lib/@loadingio/debounce.js/main/debounce.min.js"></script><script type="text/javascript" src="assets/lib/ldcaret/main/ldcaret.min.js"></script><script type="text/javascript" src="assets/lib/ldcover/main/ldcv.min.js"></script><script type="text/javascript" src="assets/lib/ldview/main/ldview.min.js"></script><script type="text/javascript" src="assets/lib/focalbox/main/focalbox.min.js"></script><script type="text/javascript" src="assets/lib/interactjs/main/interact.min.js"></script><script type="text/javascript" src="assets/lib/@plotdb/json0/main/json0.min.js"></script><script type="text/javascript" src="assets/lib/@plotdb/datahub/main/datahub.min.js"></script><script type="text/javascript" src="assets/lib/@plotdb/datadom/main/datadom.min.js"></script><script type="text/javascript" src="/assets/lib/ldcaret/main/ldcaret.min.js"></script><script>var lc, move, phAbs, makeph, keyup;
lc = {
  obj: null
};
move = function(opt){
  var _, ret, ref$, n, i, d, ph, x$, range, box;
  opt == null && (opt = {});
  _ = function(obj){
    var n, i, d, nn;
    n = obj.n, i = obj.i, d = obj.d;
    if (d) {
      if (n.nodeType === 1) {
        if (n.childNodes[i]) {
          obj.n = n.childNodes[i];
          obj.i = 0;
        } else {
          obj.n = n.parentNode;
          obj.i = Array.from(n.parentNode.childNodes).indexOf(n) + 1;
        }
      } else if (n.nodeType === 3) {
        if (i < n.length) {
          obj.i = i = i + 1;
        }
        if (i === n.length) {
          obj.n = n.parentNode;
          obj.i = Array.from(n.parentNode.childNodes).indexOf(n) + 1;
        }
      }
    } else {
      if (n.nodeType === 1) {
        if (n.childNodes[i - 1]) {
          nn = n.childNodes[i - 1];
          obj.n = nn;
          obj.i = nn.length || nn.childNodes.length;
        } else {
          obj.n = n.parentNode;
          obj.i = Array.from(n.parentNode.childNodes).indexOf(n);
        }
      } else if (n.nodeType === 3) {
        if (i > 0) {
          obj.i = i = i - 1;
        }
        if (i === 0) {
          obj.n = n.parentNode;
          obj.i = Array.from(n.parentNode.childNodes).indexOf(n);
        }
      }
    }
    return obj;
  };
  ret = ldCaret.get();
  ref$ = _({
    n: ret.ne,
    i: ret.oe,
    d: opt.inc
  }), n = ref$.n, i = ref$.i, d = ref$.d;
  if (n.nodeType === 3) {
    if (i === 0 || i === n.length) {
      ref$ = _({
        n: n,
        i: i,
        d: d
      }), n = ref$.n, i = ref$.i, d = ref$.d;
    }
  }
  if (n.nodeType === 1) {
    ph = document.createTextNode('\u200b');
    n.insertBefore(ph, n.childNodes[i]);
  }
  x$ = range = document.createRange();
  x$.setStart(n, i);
  x$.setEnd(n, i + (ph ? 1 : 0));
  box = range.getBoundingClientRect();
  ref$ = phAbs.style;
  ref$.left = box.x + "px";
  ref$.top = box.y + "px";
  if (ph) {
    n.removeChild(ph);
  }
  ldCaret.set(range);
  return lc.obj = {
    n: n,
    i: i,
    d: d,
    ph: ph ? true : false
  };
};
phAbs = ld$.find('#ph-abs', 0);
simple.addEventListener('input', function(e){
  return console.log('input');
});
simple.addEventListener('change', function(e){
  return console.log('change');
});
makeph = function(){
  return document.createTextNode("\u200b");
};
document.body.addEventListener('keydown', function(e){
  var ref$, n, i, d, ph, x$, range;
  if ((ref$ = e.keyCode) === 37 || ref$ === 39) {
    return;
  }
  if (!lc.obj) {
    return;
  }
  ref$ = lc.obj, n = ref$.n, i = ref$.i, d = ref$.d, ph = ref$.ph;
  if (!ph) {
    return;
  }
  lc.obj.ph = false;
  lc.ph1 = makeph();
  lc.ph2 = makeph();
  n.insertBefore(lc.ph1, n.childNodes[i]);
  n.insertBefore(lc.ph2, n.childNodes[i + 1]);
  x$ = range = document.createRange();
  x$.setStart(n, i + 1);
  x$.setEnd(n, i + 1);
  return ldCaret.set(range);
});
document.body.addEventListener('input', function(e){
  var ref$;
  if (!lc.obj) {
    return;
  }
  if ((ref$ = e.keyCode) === 37 || ref$ === 39) {
    return;
  }
  return keyup(e);
});
keyup = function(e){
  var ph1, ph2, delta, ref$, n, i, d, ph, x$, range;
  [lc.ph1, lc.ph2].filter(function(it){
    return it && it.parentNode;
  }).map(function(n){
    n.textContent = n.textContent.replace(/\u200b/g, '');
    if (n.textContent.length < 1) {
      return n.parentNode.removeChild(n);
    }
  });
  ph1 = lc.ph1 && lc.ph1.parentNode;
  ph2 = lc.ph2 && lc.ph2.parentNode;
  delta = ph1 && ph2
    ? 2
    : ph1 || ph2 ? 1 : 0;
  lc.ph1 = lc.ph2 = null;
  ref$ = lc.obj, n = ref$.n, i = ref$.i, d = ref$.d, ph = ref$.ph;
  x$ = range = document.createRange();
  x$.setStart(n, i + delta);
  x$.setEnd(n, i + delta);
  ldCaret.set(range);
  return lc.obj.i = i + delta;
};
/*
document.body.addEventListener \keydown, (e) ->
  if (e.keyCode in [37,39]) => return
  if !lc.obj => return
  {n,i,d} = lc.obj
  if n.nodeType == 3 => return
  lc.ph = document.createTextNode '\u200b'
  n.insertBefore lc.ph, n.childNodes[i]
  range = document.createRange!
    ..setStart n, i + 1
    ..setEnd n, i + 1 #(i + if lc.ph => 1 else 0)
  ldCaret.set range
document.body.addEventListener \keyup, (e) ->
  if !lc.ph => return
  lc.ph.textContent = lc.ph.textContent.replace /\u200b/g, ''
  if lc.ph.textContent.length < 1 => lc.ph.parentNode.removeChild lc.ph
  lc.ph = null
  lc.obj = null
*/
document.body.addEventListener('keydown', function(e){
  var ref$;
  if (!((ref$ = e.keyCode) === 37 || ref$ === 39)) {
    return;
  }
  e.preventDefault();
  return move({
    inc: e.keyCode === 39
  });
});</script></body></html>